machine:
    environment:
        GODIST: go1.7.linux-amd64.tar.gz
        GOPATH: $HOME/.go_workspace
        BUILD_NAME: etcd-bootstrap
    post:
        - mkdir -p download
        - test -e download/$GODIST || curl -o download/$GODIST https://storage.googleapis.com/golang/$GODIST
        - sudo rm -rf /usr/local/go
        - sudo tar -C /usr/local -xzf download/$GODIST

general:
    build_dir: ../.go_workspace/src/$CIRCLE_PROJECT_REPONAME

checkout:
    post:
        - mkdir -p $GOPATH/src
        - ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $GOPATH/src/$CIRCLE_PROJECT_REPONAME

dependencies:
    cache_directories:
        - ~/download
    override:
        - go get github.com/mitchellh/gox
        - go get github.com/tcnksm/ghr
        - go get -t -d -v ./...

test:
    override:
        - cd $GOPATH/src/$CIRCLE_PROJECT_REPONAME && go test -v ./...

deployment:
    release:
        tag: /v[0-9]+(\.[0-9]+)*/
        commands:
            - gox -ldflags "-X main.Version=$CIRCLE_TAG -X main.BuildDate=$(date --rfc-2822)" -osarch="linux/amd64" -output "dist/$BUILD_NAME"
            - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME --replace `git describe --tags` dist/
