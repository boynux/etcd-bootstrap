machine:
    environment:
        GODIST: go1.7.linux-amd64.tar.gz
        GOPATH: $HOME/.go_workspace
    post:
        - mkdir -p download
        - test -e download/$GODIST || curl -o download/$GODIST https://storage.googleapis.com/golang/$GODIST
        - sudo rm -rf /usr/local/go
        - sudo tar -C /usr/local -xzf download/$GODIST

general:
    build_dir: ../.go_workspace/src/$CIRCLE_PROJECT_REPONAME

checkout:
    post:
        - mkdir -p $GOPATH/src
        - ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $GOPATH/src/$CIRCLE_PROJECT_REPONAME

dependencies:
    cache_directories:
        - ~/download
    override:
        - cd $GOPATH/src/$CIRCLE_PROJECT_REPONAME && go get -t -d -v ./...

test:
    override:
        - cd $GOPATH/src/$CIRCLE_PROJECT_REPONAME && go test -v ./...

deployment:
    prod:
        branch: master
        commands:
            - go get github.com/mitchellh/gox
            - go get github.com/tcnksm/ghr
            - gox -ldflags "-X main.Version=$BUILD_VERSION -X main.BuildDate=$BUILD_DATE" -osarch="linux/amd64" -output "dist/ncd_{{.OS}}_{{.Arch}}"
            - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME --replace `git describe --tags` dist/
