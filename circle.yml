machine:
    environment:
        GODIST: go1.7.linux-amd64.tar.gz
        GOPATH: $HOME/.go_workspace
        BUILD_NAME: etcd-bootstrap
    post:
        - mkdir -p download
        - test -e download/$GODIST || curl -o download/$GODIST https://storage.googleapis.com/golang/$GODIST
        - sudo rm -rf /usr/local/go
        - sudo tar -C /usr/local -xzf download/$GODIST

general:
    build_dir: ../.go_workspace/src/$CIRCLE_PROJECT_REPONAME

checkout:
    post:
        - mkdir -p $GOPATH/src
        - ln -fs $HOME/$CIRCLE_PROJECT_REPONAME $GOPATH/src/$CIRCLE_PROJECT_REPONAME

dependencies:
    cache_directories:
        - ~/download
    override:
        - go get github.com/mitchellh/gox
        - go get github.com/tcnksm/ghr
        - sudo add-apt-repository ppa:masterminds/glide -y
        - sudo apt-get update
        - sudo apt-get install glide -y
        - glide install

test:
    override:
        - cd $GOPATH/src/$CIRCLE_PROJECT_REPONAME && go test -v -cover $(glide nv)

deployment:
    pre-release:
        branch: master
        commands:
            - gox -ldflags "-X main.Version=$CIRCLE_SHA1 -X main.BuildNumber=$CIRCLE_BUILD_NUM" -osarch="linux/amd64" -output "dist/$BUILD_NAME"
            - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME --replace pre-release dist/
    release:
        tag: /v[0-9]+(\.[0-9]+)*/
        commands:
            - gox -ldflags "-X main.Version=$CIRCLE_TAG -X main.BuildNumber=$CIRCLE_BUILD_NUM" -osarch="linux/amd64" -output "dist/$BUILD_NAME"
            - ghr -t $GITHUB_TOKEN -u $CIRCLE_PROJECT_USERNAME -r $CIRCLE_PROJECT_REPONAME $CIRCLE_TAG dist/
